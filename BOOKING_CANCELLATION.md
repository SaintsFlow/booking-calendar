# Функция отмены бронирований

## Обзор

Реализована полная система отмены и восстановления бронирований с учётом ролей пользователей.

## Основные возможности

### 1. Отмена бронирования

-   **Доступ**: Только менеджеры, админы и супер-админы
-   **Типы отмены**:
    -   `cancelled_by_admin` - отмена менеджером/админом
    -   `cancelled_by_client` - отмена по инициативе клиента
-   **Функционал**:
    -   Изменение статуса бронирования на "Отменено"
    -   Добавление причины отмены в комментарий
    -   Сохранение информации о том, кто отменил

### 2. Восстановление бронирования

-   **Доступ**: Только менеджеры, админы и супер-админы
-   **Условия**:
    -   Бронирование должно быть отменено
    -   Время начала брони должно быть в будущем
-   **Функционал**:
    -   Восстановление статуса на "Подтверждено"
    -   Возврат в обычный режим работы

### 3. Фильтрация отменённых бронирований

-   **Сотрудники**: НИКОГДА не видят отменённые бронирования
-   **Менеджеры/Админы**: Могут переключать отображение отменённых через чекбокс
-   **По умолчанию**: Отменённые бронирования скрыты для всех

## Backend изменения

### Models

**app/Models/Booking.php**

```php
// Новые scope методы:
public function scopeExcludeCancelled($query)
public function scopeOnlyCancelled($query)

// Новые helper методы:
public function isCancelled(): bool
public function canBeRestored(): bool
```

### Controllers

**app/Http/Controllers/BookingController.php**

```php
// Новые методы:
public function cancel(Request $request, Booking $booking)
public function restore(Booking $booking)
```

**app/Http/Controllers/CalendarController.php**

```php
// Изменён метод index():
// Добавлен параметр show_cancelled
// Применяется scope excludeCancelled() по умолчанию
```

### Policies

**app/Policies/BookingPolicy.php**

```php
// Новые методы авторизации:
public function cancel(User $user, Booking $booking): bool
public function restore(User $user, Booking $booking): bool
```

### Routes

**routes/web.php**

```php
Route::post('/bookings/{booking}/cancel', [BookingController::class, 'cancel']);
Route::post('/bookings/{booking}/restore', [BookingController::class, 'restore']);
```

## Frontend изменения

### Store

**resources/js/stores/calendar.js**

```javascript
// Новое состояние:
const showCancelled = ref(false);

// Параметр передаётся в API:
if (showCancelled.value) {
    params.show_cancelled = true;
}
```

### Компоненты

**resources/js/Pages/Calendar/Index.vue**

-   Добавлен чекбокс "Показать отменённые" (только для менеджеров/админов)
-   Watch для автоматической перезагрузки при изменении showCancelled
-   Сброс фильтра showCancelled при нажатии "Сбросить фильтры"

**resources/js/Components/Modals/BookingModal.vue**

-   Визуальное уведомление об отменённом бронировании (красный блок)
-   Кнопка "Отменить бронь" (для менеджеров/админов, только для активных броней)
-   Кнопка "Восстановить бронь" (для менеджеров/админов, только для отменённых будущих броней)
-   Блокировка редактирования отменённых бронирований

## Бизнес-логика

### Права доступа

| Роль                      | Видит отменённые    | Может отменить | Может восстановить |
| ------------------------- | ------------------- | -------------- | ------------------ |
| Сотрудник (employee)      | ❌ Никогда          | ❌ Нет         | ❌ Нет             |
| Менеджер (manager)        | ✅ С переключателем | ✅ Любые брони | ✅ Будущие брони   |
| Админ (admin)             | ✅ С переключателем | ✅ Любые брони | ✅ Будущие брони   |
| Супер-админ (super_admin) | ✅ С переключателем | ✅ Любые брони | ✅ Будущие брони   |

### Workflow отмены

1. Менеджер/админ открывает бронирование в календаре
2. Нажимает кнопку "Отменить бронь"
3. Вводит причину отмены (опционально)
4. Система:
    - Изменяет статус на `cancelled_by_admin`
    - Добавляет причину в комментарий (если указана)
    - Обновляет календарь
    - Бронирование исчезает из обычного вида

### Workflow восстановления

1. Менеджер/админ включает чекбокс "Показать отменённые"
2. Видит отменённые бронирования в календаре
3. Открывает отменённое бронирование
4. Нажимает кнопку "Восстановить бронь"
5. Подтверждает действие
6. Система:
    - Изменяет статус на `confirmed`
    - Возвращает бронирование в обычный режим

### Ограничения

1. **Сотрудники**: Никогда не видят и не могут управлять отменёнными бронированиями
2. **Восстановление**: Можно восстановить только бронирования в будущем
3. **По умолчанию**: Отменённые бронирования скрыты для всех ролей
4. **Редактирование**: Отменённые бронирования нельзя редактировать, только восстановить

## Статусы

Существующие статусы для отмены (создаются автоматически при создании тенанта):

```php
'cancelled_by_client' => [
    'name' => 'Отменено клиентом',
    'color' => '#EF4444'
]

'cancelled_by_admin' => [
    'name' => 'Отменено администратором',
    'color' => '#DC2626'
]
```

## API Endpoints

### Отмена бронирования

```http
POST /api/bookings/{booking}/cancel

Request:
{
    "cancel_reason": "Клиент не смог прийти", // optional
    "cancelled_by_admin": true
}

Response 200:
{
    "message": "Бронирование успешно отменено",
    "booking": { ... }
}

Response 403:
{
    "message": "У вас нет прав для отмены этого бронирования"
}
```

### Восстановление бронирования

```http
POST /api/bookings/{booking}/restore

Response 200:
{
    "message": "Бронирование успешно восстановлено",
    "booking": { ... }
}

Response 403:
{
    "message": "У вас нет прав для восстановления этого бронирования"
}

Response 422:
{
    "message": "Это бронирование уже прошло и не может быть восстановлено"
}
```

### Получение календаря с отменёнными

```http
GET /api/calendar?show_cancelled=true&view=week&date=2024-01-15

Response:
{
    "calendar": [ ... ],
    "workplaces": [ ... ],
    "employees": [ ... ]
}
```

## Тестирование

### Как протестировать отмену:

1. Войти как менеджер/админ
2. Открыть любое бронирование в календаре
3. Нажать "Отменить бронь"
4. Ввести причину отмены
5. Проверить, что бронирование исчезло из календаря

### Как протестировать восстановление:

1. Войти как менеджер/админ
2. Включить чекбокс "Показать отменённые"
3. Открыть отменённое будущее бронирование
4. Нажать "Восстановить бронь"
5. Подтвердить действие
6. Проверить, что бронирование вернулось в обычный вид

### Как протестировать ограничения для сотрудников:

1. Войти как сотрудник (employee)
2. Проверить, что чекбокс "Показать отменённые" отсутствует
3. Проверить, что отменённые брони не видны в календаре
4. Попробовать обратиться к API напрямую с параметром show_cancelled=true
5. Убедиться, что отменённые брони всё равно не возвращаются

## Примечания

-   Отмена бронирования **НЕ удаляет** запись из базы данных
-   Используется статусный подход для обратимости операций
-   История изменений сохраняется в комментариях
-   Система поддерживает audit trail (кто и когда отменил)
-   WebSocket обновления работают для всех изменений статусов
